<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>NFT Admin</title>
  <meta name="description" content="NFT Admin" />
</head>

<body>
  <script src="https://unpkg.com/axios/dist/axios.min.js" type="application/javascript"></script>
  <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="application/javascript"></script>

  <script>
    axios.defaults.withCredentials = true;

    async function get_nonce_and_sign() { }

    async function conn_metamask() {
      await window.ethereum.enable();
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = await provider.getSigner();
      const addr = await signer.getAddress();

      var meta_mask = document.getElementById("meta_mask");
      console.log(provider, signer, addr)
      await axios
        .get(`http://127.0.0.1:8080/nonce?address=${addr}`)
        .then(async (obj) => {
          console.log(obj)
          await signer.signMessage(obj.data).then(async (sign) => {
            console.log(sign)
            console.log(sign.toString());
            await axios
              .post("http://127.0.0.1:8080/authenticate", {
                withCredentials: true,
                credentials: "include",
                address: addr,
                signature: sign.toString(),
              })
              .then((data) => {
                if (data.status === 200) {
                  meta_mask.innerHTML = `AUTH SUCCESSFUL! ${addr}`;
                }
              })
              .catch(
                (meta_mask.innerHTML = "AUTH FAILED OR ADMIN KEY NOT ADDED")
              );
          });
        })
        .catch((meta_mask.innerHTML = "AUTH FAILED OR ADMIN KEY NOT ADDED"));
    }

    async function approve(_id) {
      var element1 = document.getElementById(_id);
      var res1 = axios.post("http://127.0.0.1:8080/approve", {
        id: _id,
        withCredentials: true,
        credentials: "include",
      });

      res1
        .then((res) => {
          if (res.status === 200) {
            element1.innerHTML = `<p>Approved Successfully!<p><p>-------------------------------<p>`;
          } else {
            element1.innerHTML += `<p>Error Occured!<p><p>-------------------------------<p>`;
          }
        })
        .catch(
          (element1.innerHTML += `<p>Error Occured!<p><p>-------------------------------<p>`)
        );
    }
    async function decline(_id) {
      var element2 = document.getElementById(_id);
      var res2 = axios.post("http://127.0.0.1:8080/decline", {
        id: _id,
        withCredentials: true,
        credentials: "include",
      });

      res2
        .then((res) => {
          if (res.status === 200) {
            element2.innerHTML = `<p>Declined Successfully!<p><p>-------------------------------<p>`;
          } else {
            element2.innerHTML += `<p>Error Occured!<p><p>-------------------------------<p>`;
          }
        })
        .catch(
          (element2.innerHTML += `<p>Error Occured!<p><p>-------------------------------<p>`)
        );
    }
    async function clicked() {
      let data_;
      var res = axios.get("http://127.0.0.1:8080/all", {
        withCredentials: true,
        credentials: "include",
      });

      await res.then((obj) => {
        data_ = obj.data;
      });

      var element = document.getElementById("all_items");

      data_.forEach((item) => {
        element.innerHTML += `
              <div id=${item._id}>
                <p>ObjectId: ${item._id}<p><p>Name: ${item.name}<p><p>Description: ${item.description}<p><p>Image URL: ${item.image}<p><p>External URL: ${item.externam_url}<p><p>Timestamp: ${item.timestamp}<p><button value=${item._id} onclick="approve(this.value)">Approve</button> <button value=${item._id} onclick="decline(this.value)">Decline</button><p>-------------------------------<p>
              </div>
            `;
      });
    }
  </script>

  <div id="root">
    <div id="meta_mask">
      <button onclick="conn_metamask()">CONNECT METAMASK</button>
    </div>

    <br />

    <button onclick="clicked()">ALL MINT REQUESTS</button>
  </div>

  <div id="all_items"></div>
</body>

</html>